{% extends 'shop/base.html' %}
{% load static %}

{% block title %}Checkout{% endblock %}

{% block content %}
<section class="checkout-section container py-5" style="padding-top: 7rem;">
  <h2 class="fw-bold text-center text-light mb-5">Checkout</h2>

  <div class="row g-4 justify-content-center">

    <div class="col-lg-5">
      <div class="glass-box p-4 rounded-4 shadow-lg">
        <h4 class="text-light mb-3">Order Summary</h4>

        <div id="checkout-items"></div>

        <div class="d-flex justify-content-between mt-3 text-light fw-bold">
          <span>Grand Total:</span>
          <span>₹<span id="checkout-total">0</span></span>
        </div>
      </div>
    </div>
    <div class="col-lg-5">
      <div class="glass-box p-4 rounded-4 shadow-lg">
        <h4 class="text-light mb-3">Shipping Details</h4>

        <form id="checkout-form" method="POST" action="{% url 'shop:place_order' %}">
          {% csrf_token %}

          <div class="mb-3">
            <label class="text-light">Full Name</label>
            <input type="text" class="form-control glass-input" name="name"
                   value="{{ user.username }}" required>
          </div>

          <div class="mb-3">
            <label class="text-light">Email</label>
            <input type="email" class="form-control glass-input" name="email"
                   value="{{ user.email }}" required>
          </div>

          <div class="mb-3">
            <label class="text-light">Phone Number</label>
            <input type="tel" class="form-control glass-input" name="phone"
                   placeholder="Enter phone number" required>
          </div>

          <div class="mb-3">
            <label class="text-light">Address</label>
            <textarea class="form-control glass-input" rows="3" name="address"
                      placeholder="Complete shipping address" required></textarea>
          </div>

          <h5 class="text-light mt-4">Payment Method</h5>
          <div class="d-flex gap-3 mt-2">
            <label class="text-light">
              <input type="radio" name="payment_method" value="COD" checked>
              Cash on Delivery
            </label>
            <label class="text-light">
              <input type="radio" name="payment_method" value="ONLINE">
              Online Payment
            </label>
          </div>
          <input type="hidden" id="order-data" name="order_data">

          <button type="submit" class="btn btn-warning w-100 mt-4 fw-bold py-2">
            Place Order
          </button>
        </form>

      </div>
    </div>
  </div>
</section>

<!-- ✅ CHECKOUT JS -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const checkoutItems = document.getElementById("checkout-items");
  const checkoutTotal = document.getElementById("checkout-total");
  const orderDataInput = document.getElementById("order-data");
  const form = document.getElementById("checkout-form");

  const buyNowItem = JSON.parse(localStorage.getItem("buy_now_item"));
  const cart = JSON.parse(localStorage.getItem("cart")) || [];

  const finalItems = buyNowItem ? [buyNowItem] : cart;
  let total = 0;
  checkoutItems.innerHTML = "";
  finalItems.forEach(item => {
    const itemTotal = (item.price * item.quantity);
    total += itemTotal;
    checkoutItems.innerHTML += `
      <div class="d-flex align-items-center justify-content-between mb-3 text-light">
        <div class="d-flex align-items-center">
          <img src="${item.image}" width="70" class="rounded me-3" alt="${item.name}">
          <div>
            <h6 class="mb-0">${item.name}</h6>
            <small>Qty: ${item.quantity}</small>
          </div>
        </div>
        <h6 class="text-warning">₹${itemTotal.toFixed(2)}</h6>
      </div>
    `;
  });
  checkoutTotal.textContent = total.toFixed(2);
  form.addEventListener("submit", function () {
    orderDataInput.value = JSON.stringify(finalItems);
  });
});
</script>
{% endblock %}
